# 第一阶段：使用 Golang 编译 BaiduPCS
FROM golang:latest AS builder1
LABEL authors="zen"

# 设置非交互模式
ENV DEBIAN_FRONTEND=noninteractive

COPY BaiduPCS-Go /BaiduPCS-Go
WORKDIR /BaiduPCS-Go

# 合并检查、更新依赖和构建操作
RUN ls && go vet && go mod tidy && go mod vendor && go build -o BaiduPCS main.go

# 第二阶段：使用 Golang 编译 tdl
FROM golang:latest AS builder2
LABEL authors="zen"

# 设置非交互模式
ENV DEBIAN_FRONTEND=noninteractive

COPY tdl-go /tdl-go
WORKDIR /tdl-go

# 合并检查、更新依赖和构建操作
RUN ls && go vet && go mod tidy && go build -o tdl main.go

# 第三阶段：使用 Golang 编译 VideoDualEmbed
FROM golang:latest AS builder3
LABEL authors="zen"

# 设置非交互模式
ENV DEBIAN_FRONTEND=noninteractive

COPY VideoDualEmbed /VideoDualEmbed
WORKDIR /VideoDualEmbed

# 合并检查、更新依赖和构建操作
RUN ls && go vet && go mod tidy && go build -o vde main.go

# 最终阶段：构建 GPU 运行环境
FROM nvidia/cuda:13.1.1-cudnn-runtime-ubuntu24.04
LABEL authors="zen"

# 设置非交互模式
ENV DEBIAN_FRONTEND=noninteractive

# 安装基础系统工具
RUN apt update && \
    apt full-upgrade -y && \
    apt install -y --no-install-recommends \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg \
        lsb-release && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*

# 配置 Ubuntu 软件源（如果需要）
# RUN sed -i 's/archive.ubuntu.com/mirrors.ustc.edu.cn/g' /etc/apt/sources.list

# 更新系统并安装基础依赖
RUN apt update && \
    apt full-upgrade -y && \
    # 基础系统工具
    apt install -y --no-install-recommends \
        python3 python3-pip python3-dev \
        ca-certificates \
        bsdmainutils \
        sqlite3 \
        gawk \
        locales \
        wget \
        curl \
        gnupg && \
    # 多媒体处理工具
    apt install -y --no-install-recommends \
        ffmpeg \
        mediainfo \
        libavif-bin && \
    # 文本处理和转换工具
    apt install -y --no-install-recommends \
        translate-shell \
        libfribidi-bin \
        dos2unix \
        p7zip-full && \
    # 开发工具
    apt install -y --no-install-recommends \
        build-essential \
        npm && \
    # 系统监控工具
    apt install -y --no-install-recommends \
        htop \
        btop && \
    # 下载工具
    apt install -y --no-install-recommends \
        axel \
        aria2 && \
    # 编辑器和服务器
    apt install -y --no-install-recommends \
        nano \
        openssh-server && \
    # 中文字体
    apt install -y --no-install-recommends \
        fonts-wqy-microhei \
        fonts-wqy-zenhei \
        fonts-noto-cjk && \
    # 清理缓存
    apt clean && \
    rm -rf /var/lib/apt/lists/*

# 安装 Node.js 工具
RUN npm install -g deno && \
    deno --version

# 复制编译好的二进制文件
COPY --from=builder1 /BaiduPCS-Go/BaiduPCS /usr/local/bin/BaiduPCS
COPY --from=builder2 /tdl-go/tdl /usr/local/bin/tdl
COPY --from=builder3 /VideoDualEmbed/vde /usr/local/bin/vde

# 安装 Python 依赖（适配 Ubuntu 环境）
RUN rm -f /usr/lib/python3*/EXTERNALLY-MANAGED && \
    pip3 install --break-system-packages --no-cache-dir openai-whisper && \
    pip3 install --break-system-packages --no-cache-dir -U --pre yt-dlp[default]

# 配置 Go 环境变量
RUN go env -w GO111MODULE=on && \
    go env -w GOPROXY=https://goproxy.cn,direct && \
    go env -w GOBIN=/go/bin

# 配置中文语言支持
RUN apt install -y --no-install-recommends locales && \
    echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen zh_CN.UTF-8 && \
    update-locale LANG=zh_CN.UTF-8 && \
    # 清理缓存
    apt clean && \
    rm -rf /var/lib/apt/lists/*

# 配置国内镜像源
RUN sed -i 's/archive.ubuntu.com/mirrors.ustc.edu.cn/g' /etc/apt/sources.list

# 设置环境变量
ENV LANG=zh_CN.UTF-8 \
    LANGUAGE=zh_CN:zh \
    LC_ALL=zh_CN.UTF-8 \
    PATH="$PATH:/usr/local/go/bin:/usr/local/cuda/bin" \
    LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH" \
    CUDA_HOME="/usr/local/cuda"

# 配置 SSH 服务
RUN echo "root:123456" | chpasswd && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config

# 验证 GPU 支持
RUN nvidia-smi || echo "NVIDIA driver not available in build environment"

# 配置国内镜像源后的pip源设置
RUN pip3 config set global.index-url https://mirrors.ustc.edu.cn/pypi/simple

# 启动 SSH 服务
WORKDIR /
ENTRYPOINT ["service", "ssh", "start", "-D"]